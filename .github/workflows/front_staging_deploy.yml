name: Deploy to Azure App Service

# Required secrets (set in repository or environment secrets):
# - `AZURE_SP`: Azure service principal JSON used by `azure/login`.
# - `ACR_NAME` or `ACR_LOGIN_SERVER`: ACR short name (for `az acr login`) or full login server (e.g. `myreg.azurecr.io`).
# - `ACR_USERNAME` / `ACR_PASSWORD`: optional, if using `docker login` instead of `az acr login`.
# - `AZURE_APP_SERVICE_BACKEND`: App Service name to deploy the frontend image to.

on:
  push:
    branches:
      - develop
    paths:
      - "frontend/**"

# Allow this workflow to push back a refreshed outputs file
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: staging
    steps:
      - name: Check out the code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_SP }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to ACR
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build and push Docker image for Frontend
        run: |
          docker build --push -t ${{ secrets.ACR_LOGIN_SERVER }}/civic-chatbot-frontend:latest ./frontend

      - name: Deploy frontend to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_APP_SERVICE_BACKEND }}
          images: |
            ${{ secrets.ACR_LOGIN_SERVER }}/civic-chatbot-frontend:latest

      - name: Install jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Refresh azure-outputs.json from deployment outputs
        env:
          AZURE_ENV_RG: ${{ secrets.AZURE_RESOURCE_GROUP || 'civic-chatbot-rg' }}
          AZURE_DEPLOYMENT_NAME: ${{ secrets.AZURE_DEPLOYMENT_NAME || 'main' }}
        run: |
          chmod +x ./infrastructure/scripts/export-azure-outputs.sh
          ./infrastructure/scripts/export-azure-outputs.sh -g "$AZURE_ENV_RG" -n "$AZURE_DEPLOYMENT_NAME" -o infrastructure/azure-outputs.json

      - name: Upload azure-outputs.json as artifact
        uses: actions/upload-artifact@v4
        with:
          name: azure-outputs
          path: infrastructure/azure-outputs.json
          # retention-days: 7

      - id: parse-outputs
        name: Parse azure-outputs.json into step outputs
        run: |
          if [ ! -f infrastructure/azure-outputs.json ]; then
            echo "azure-outputs.json not found" >&2
            exit 1
          fi

          acrLoginServer=$(jq -r '.acrLoginServer // empty' infrastructure/azure-outputs.json)
          acrName=$(jq -r '.acrName // empty' infrastructure/azure-outputs.json)
          stagingAppName=$(jq -r '.stagingAppName // empty' infrastructure/azure-outputs.json)
          prodAppName=$(jq -r '.prodAppName // empty' infrastructure/azure-outputs.json)
          subscriptionId=$(jq -r '.subscriptionId // empty' infrastructure/azure-outputs.json)

          echo "acr_login_server=${acrLoginServer}" >> $GITHUB_OUTPUT
          echo "acr_name=${acrName}" >> $GITHUB_OUTPUT
          echo "staging_app=${stagingAppName}" >> $GITHUB_OUTPUT
          echo "prod_app=${prodAppName}" >> $GITHUB_OUTPUT
          echo "subscription_id=${subscriptionId}" >> $GITHUB_OUTPUT
